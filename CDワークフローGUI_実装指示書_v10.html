<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CD取り込み自動化ワークフロー・マスターGUI 実装指示書 (v10)</title>
<style>
    body {
        font-family: 'Helvetica Neue', Arial, 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', Meiryo, sans-serif;
        line-height: 1.6;
        color: #333;
        max-width: 960px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f4f7f6;
    }
    h1 {
        color: #2c3e50;
        border-bottom: 2px solid #3498db;
        padding-bottom: 10px;
        margin-top: 30px;
    }
    h2 {
        color: #34495e;
        border-left: 5px solid #3498db;
        padding-left: 10px;
        margin-top: 25px;
        background-color: #e8f6f3;
    }
    h3 {
        color: #2980b9;
        margin-top: 20px;
    }
    code {
        background-color: #fff3e0;
        padding: 2px 4px;
        border-radius: 3px;
        font-family: Consolas, 'Courier New', Courier, monospace;
        color: #e67e22;
    }
    pre {
        background-color: #2d3436;
        color: #dfe6e9;
        padding: 15px;
        border-radius: 5px;
        overflow-x: auto;
        font-family: Consolas, 'Courier New', Courier, monospace;
        border: 1px solid #b2bec3;
    }
    ul, ol {
        padding-left: 25px;
    }
    li {
        margin-bottom: 8px;
    }
    .directory-structure {
        font-family: Consolas, 'Courier New', Courier, monospace;
        white-space: pre;
        background-color: #fff;
        padding: 15px;
        border-radius: 5px;
        border: 1px solid #ddd;
        overflow-x: auto;
        color: #2d3436;
    }
    .note {
        background-color: #fff3cd;
        border-left: 5px solid #ffc107;
        padding: 15px;
        margin-bottom: 20px;
    }
</style>
</head>
<body>

<h1>CD取り込み自動化ワークフロー・マスターGUI 実装指示書 (v10)</h1>

<div class="note">
    <strong>本書の位置づけ:</strong> 本ドキュメントは、ユーザー定義のCD取り込みワークフローを管理・自動化するGUIアプリケーションの開発に向けた実装指示書である。要件定義書、およびユーザーとの一問一答に基づき、Python (PySide6) を用いた具体的な実装方針を定める。v10ではDemucs自動除外ロジックに「インストペア曲の検知」を追加した。
</div>

<h2>1. プロジェクト概要</h2>

<h3>1.1. 開発環境・依存関係</h3>
<ul>
    <li><strong>言語</strong>: Python 3.12</li>
    <li><strong>GUIフレームワーク</strong>: PySide6 (Qt for Python)</li>
    <li><strong>必須ライブラリ</strong> (仮想環境での <code>pip install</code> を前提とする):
        <ul>
            <li><code>PySide6</code>: GUI構築、外部プロセス管理 (<code>QProcess</code>)</li>
            <li><code>mutagen</code>: オーディオファイルのメタデータ（アートワーク有無）の検査</li>
            <li><code>send2trash</code>: 作業フォルダの安全な削除（ゴミ箱への移動）</li>
        </ul>
    </li>
</ul>

<h3>1.2. 動作環境</h3>
<ul>
    <li><strong>OS</strong>: Windows 10 / 11</li>
    <li><strong>実行形態</strong>: 仮想環境 (<code>.venv</code>) を利用したスクリプト実行。起動は専用のバッチファイル (<code>LAUNCH_GUI.bat</code>) から行うことを推奨する。</li>
</ul>

<hr>

<h2>2. システム構成とファイル配置</h2>

<h3>2.1. アプリケーション本体</h3>
<div class="directory-structure">ProjectRoot/
  ├─ LAUNCH_GUI.bat      # ★起動用バッチファイル (ここから起動する)
  ├─ main.py             # エントリーポイント (GUI起動)
  ├─ config.ini          # ユーザー設定ファイル (パス等)
  ├─ requirements.txt    # 依存ライブラリ一覧
  ├─ .venv/              # Python仮想環境 (作成推奨)
  ├─ gui/                # GUIコンポーネント
  │   ├─ main_window.py  # メイン画面
  │   ├─ step_panels/    # 各ステップのUIパネル
  │   └─ dialogs/        # 設定画面、確認ダイアログ等
  ├─ logic/              # ビジネスロジック
  │   ├─ workflow.py     # ステップ進行管理
  │   ├─ state_manager.py# state.json の読み書き
  │   └─ external_tools.py # 外部ツール実行・監視 (QProcessラッパー)
  └─ scripts/            # 自動化用バッチ/PS1 (必要に応じて)</div>

<h3>2.2. 作業ディレクトリ (work) の最終構成</h3>
<p>全ステップ完了直前（ステップ9終了時点）の、1アルバムあたりのフォルダ構成例。</p>
<div class="directory-structure">work/
  └─ [Album A]/                     <-- アルバムごとのルート
       ├─ state.json                <-- 状態管理ファイル
       ├─ 01 - Renamed.flac         <-- 完成品FLAC (タグ・アート・リネーム済み)
       ├─ 02 - Renamed (Inst).flac  <-- Demucs成果物のFLAC
       │
       ├─ _aac_output/              <-- ステップ4成果物 (MediaHuman出力先)
       │    ├─ 01 - Renamed.m4a
       │    └─ 02 - Renamed (Inst).m4a
       │
       ├─ _opus_output/             <-- ステップ5成果物 (foobar2000出力先)
       │    ├─ 01 - Renamed.opus
       │    └─ 02 - Renamed (Inst).opus
       │
       ├─ _artwork_resized/         <-- ステップ6成果物 (magick出力先)
       │    ├─ cover.jpg            <-- 600px, Q85
       │    └─ cover.webp           <-- 600px, Q85
       │
       ├─ _final_flac/              <-- ステップ8成果物 (最終コピー先)
       │    ├─ 01 - Renamed.flac    <-- ReplayGainタグ付与済み
       │    └─ 02 - Renamed (Inst).flac
       │
       ├─ htdemucs_ft/              <-- ステップ2一時ファイル (Demucs出力)
       │    └─ [OriginalFileName]/  <-- フォルダ名は可変 (GUIで指定させる)
       │         ├─ vocals.wav      <-- または .flac
       │         ├─ no_vocals.wav   <-- または minus_vocals.flac 等
       │         └─ ...
       │
       └─ _logs/                    <-- 各自動処理のログ
            ├─ step2_demucs_post.log
            ├─ step6_artwork.log
            └─ ...</div>

<hr>

<h2>3. データ構造定義</h2>

<h3>3.1. <code>config.ini</code> (設定ファイル)</h3>
<pre><code>[Paths]
# 必須ツール (フルパス推奨。空欄の場合はPATHから検索し、警告を表示)
FastCopy = "C:\Tools\FastCopy\FastCopy.exe"
Mp3Tag = "C:\Program Files\Mp3tag\Mp3tag.exe"
MediaHuman = "C:\Program Files\MediaHuman\Audio Converter\MHAudioConverter.exe"
Foobar2000 = "C:\Program Files\foobar2000\foobar2000.exe"
WinSCP = "C:\Program Files (x86)\WinSCP\WinSCP.exe"
Flac = "C:\Tools\flac\flac.exe"
Metaflac = "C:\Tools\flac\metaflac.exe"
Magick = "C:\Program Files\ImageMagick-7.x.x\magick.exe"

# 作業・監視ディレクトリ
MusicCenterDir = "D:\Music\Music Center"
WorkDir = "D:\MyCdWorkflow\work"
NasFlacDir = "\\MyNAS\Music\FLAC_Archive"

[Settings]
# アートワーク縮小品質
JpegQuality = 85
WebpQuality = 85

[Demucs]
# 自動スキップ対象のキーワード（カンマ区切り）。
SkipKeywords = instrumental, inst., (inst), -inst-, off vocal, off-vocal, offvocal, backing track, karaoke, voiceless, minus one, game version, オリジナル・カラオケ, ソロ・リミックス, ドラマ, ボーナス・トラック, インスト, オフボーカル, オフボ, カラオケ, 歌無し</code></pre>

<h3>3.2. <code>state.json</code> (状態管理ファイル)</h3>
<pre><code>{
  "version": "1.0",
  "albumName": "Album A",
  "artistName": "Artist X",
  "currentStep": 3,            // 整数値でステップを管理 (1〜10)
  "status": "WAITING_USER",    // WAITING_USER, RUNNING_AUTO, RUNNING_MANUAL, ERROR, COMPLETED
  "tracks": [
    {
      "originalFile": "01 - Track.flac",
      "finalFile": "01 - Renamed.flac",  // ステップ3完了までは originalFile と同じか空
      "demucsTarget": false
    }
  ],
  "hasArtwork": null,          // true/false/null(未定)
  "flags": {                   // ステップごとの細かい状態フラグ
    "step2_skipped": false
  },
  "lastError": null
}</code></pre>

<hr>

<h2>4. 実装詳細：起動スクリプト (LAUNCH_GUI.bat)</h2>

<p>ユーザーの利便性向上のため、以下の機能を持つ起動用バッチファイルをプロジェクトルートに配置する。</p>
<ul>
    <li>仮想環境 (<code>.venv</code>) の存在チェックと自動アクティベート</li>
    <li>GUI本体 (<code>main.py</code>) の起動</li>
    <li>エラー時のコンソール一時停止 (PAUSE)</li>
</ul>

<pre><code>@echo off
chcp 65001 > nul
setlocal

rem --- ヘルプ表示 ---
if "%~1"=="-h" goto :HELP
if "%~1"=="--help" goto :HELP

rem --- 仮想環境の探索とアクティベート ---
if exist ".venv\Scripts\activate.bat" (
    echo [INFO] 仮想環境 (.venv) をアクティベートします...
    call ".venv\Scripts\activate.bat"
) else (
    echo [WARNING] 仮想環境 (.venv) が見つかりません。
    echo システムのPythonで実行を試みます...
)

rem --- GUI起動 ---
echo [INFO] CDワークフローGUIを起動しています...
python main.py %*

if %ERRORLEVEL% neq 0 (
    echo.
    echo [ERROR] GUIが異常終了しました (Exit Code: %ERRORLEVEL%)
    pause
)
goto :EOF

:HELP
echo ============================================================
echo  CDワークフローGUI 起動スクリプト
echo ============================================================
echo.
echo  使用方法:
echo    LAUNCH_GUI.bat [オプション]
echo.
echo  オプション:
echo    -h, --help    このヘルプを表示します
echo.
echo  説明:
echo    Python仮想環境 (.venv) を自動的に検出し、アクティベートした上で
echo    CDワークフローのメインGUI (main.py) を起動します。
echo.
pause
goto :EOF
</code></pre>

<hr>

<h2>5. 実装詳細：各ステップのワークフロー</h2>

<h3>ステップ1：新規取り込み</h3>
<ol>
    <li><strong>UI</strong>: <code>QFileDialog</code> で <code>MusicCenterDir</code> 起点のフォルダを選択させる。 Music Centerのフォルダ構成からアーティスト名・アルバム名を取得。</li>
    <li><strong>競合チェック</strong>: <code>WorkDir</code> 内に同名フォルダが存在するか確認し、存在する場合は中断か削除（<code>send2trash</code>）を選択させる。</li>
    <li><strong>実行</strong>: <code>FastCopy</code> で移動。</li>
    <li><strong>完了後</strong>: <code>state.json</code> を初期化。</li>
</ol>

<h3>ステップ2：Demucs処理</h3>
<ol>
    <li><strong>UI</strong>: <code>tracks</code> 内の <code>originalFile</code> 一覧をチェックボックス付きで表示。「Demucs実行」と「スキップ」ボタンを用意。
        <ul>
            <li><strong>一括操作ボタン</strong>: 「全選択」と「全解除」ボタンを追加。</li>
            <li><strong>高度な自動検出</strong>: <code>SkipKeywords</code> を用いてインスト曲を特定し、さらに「そのインスト曲のペアとなる原曲」も自動的に除外対象とする。</li>
        </ul>
<pre><code>import re

def detect_demucs_targets(track_filenames: list[str], keywords: list[str]) -> dict[str, bool]:
    """
    全トラックを解析し、各ファイルのDemucs推奨フラグ(True=対象, False=除外)を返す。
    """
    targets = {f: True for f in track_filenames}
    if not keywords:
        return targets

    pattern_str = "|".join(map(re.escape, keywords))
    # (Off Vocal) 等の表記を捕捉する正規表現
    keyword_regex = re.compile(f"(?i)\\s*[\\[\\(-]?\\s*({pattern_str})\\s*[\\]\\)-]?", re.UNICODE)

    # 1. 明示的なインスト曲を検出
    inst_files = []
    for f in track_filenames:
        base_name = re.sub(r'\.[^.]+$', '', f)
        if keyword_regex.search(base_name):
            targets[f] = False  # インスト曲そのものは除外
            inst_files.append(f)

    # 2. インスト曲のペアとなる原曲を検出（簡易実装）
    # 例: "03 Song (Off Vocal).flac" から "Song" を取り出し、"01 Song.flac" を探す
    for inst_f in inst_files:
        base_name = re.sub(r'\.[^.]+$', '', inst_f)
        # キーワード部分を除去して原曲名(推定)を作成
        original_name_guess = keyword_regex.sub('', base_name).strip()
        # トラック番号除去 ("01 - Song" -> "Song") も考慮が必要だが、
        # ここでは単純な部分一致でペア候補を探す
        for f in track_filenames:
            if targets[f] and original_name_guess in f and f != inst_f:
                 # 厳密な一致判定は難しいが、安全側に倒して「ペア候補があれば除外」とするか要検討。
                 # 今回は「推定原曲名が、他のファイル名に含まれていたら」除外候補とする。
                 targets[f] = False

    return targets</code></pre>
    </li>
    <li><strong>実行（Demucs実行押下時）</strong>:
        <ul>
            <li>ユーザーが手動でDemucsを実行。「Demucs完了」ボタンを押下させる。</li>
            <li><strong>フォルダ指定</strong>: <code>QFileDialog</code> を開き、ユーザーにDemucsの出力フォルダ（例: <code>.../htdemucs/AlbumName</code>）を選択させる。</li>
            <li><strong>バリデーション</strong>: 選択されたフォルダ内に、インストゥルメンタル音源（<code>no_vocals.wav</code> または <code>minus_vocals.flac</code> 等）が存在することを確認する。</li>
            <li>成功後、発見したファイルを <code>flac.exe</code>, <code>metaflac.exe</code> で変換・タグ処理し、<code>work</code>ルートへ移動。</li>
        </ul>
    </li>
</ol>

<h3>ステップ3：Mp3Tag（FLAC完成）</h3>
<ol>
    <li><strong>実行</strong>: <code>Mp3tag.exe</code> を起動し監視。</li>
    <li><strong>完了後UI</strong>: 左右のリストで <code>originalFile</code> と現在の <code>.flac</code> ファイルを手動紐づけ。</li>
    <li><strong>アートワーク判定</strong>: <code>mutagen</code> で全FLACを検査。画像がなければ以降のアートワーク関連ステップをスキップ設定。</li>
</ol>

<h3>ステップ4・5：変換 (MediaHuman / foobar2000)</h3>
<ol>
    <li><strong>実行</strong>: 各ツールを起動し監視。</li>
    <li><strong>完了後</strong>: ユーザーが指定した出力先（またはデフォルトの <code>_aac_output</code> / <code>_opus_output</code>）のファイル数をバリデーション。</li>
</ol>

<h3>ステップ6：アートワーク縮小（自動）</h3>
<ol>
    <li><strong>実行</strong>: <code>hasArtwork</code> が <code>true</code> なら、<code>magick.exe</code> でJPG/WebPを生成。</li>
</ol>

<h3>ステップ7：アートワーク交換（手動）</h3>
<ol>
    <li><strong>実行</strong>: <code>Mp3tag.exe</code> を起動し、指示を表示。</li>
</ol>

<h3>ステップ8・9：最終処理</h3>
<ul>
    <li><strong>ステップ8</strong>: <code>foobar2000</code> でReplayGainスキャン後、<code>_final_flac</code> へコピー。</li>
    <li><strong>ステップ9</strong>: <code>WinSCP</code> 起動。手動転送指示を表示。</li>
</ul>

<h3>ステップ10：クリーンアップ</h3>
<ul>
    <li>作業完了したアルバムフォルダを <code>send2trash</code> でゴミ箱へ移動。</li>
</ul>

</body>
</html>