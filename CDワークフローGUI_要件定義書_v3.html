<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CD取り込み自動化ワークフロー・マスターGUI 要件定義書 (v3)</title>
<style>
    body {
        font-family: 'Helvetica Neue', Arial, 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', Meiryo, sans-serif;
        line-height: 1.6;
        color: #333;
        max-width: 960px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f4f7f6;
    }
    h1 {
        color: #2c3e50;
        border-bottom: 2px solid #3498db;
        padding-bottom: 10px;
        margin-top: 30px;
    }
    h2 {
        color: #34495e;
        border-left: 5px solid #3498db;
        padding-left: 10px;
        margin-top: 25px;
        background-color: #e8f6f3;
    }
    h3 {
        color: #2980b9;
        margin-top: 20px;
    }
    h4 {
        color: #16a085;
        margin-top: 15px;
    }
    code {
        background-color: #fff3e0;
        padding: 2px 4px;
        border-radius: 3px;
        font-family: Consolas, 'Courier New', Courier, monospace;
        color: #e67e22;
    }
    pre {
        background-color: #2d3436;
        color: #dfe6e9;
        padding: 15px;
        border-radius: 5px;
        overflow-x: auto;
        font-family: Consolas, 'Courier New', Courier, monospace;
        border: 1px solid #b2bec3;
    }
    ul, ol {
        padding-left: 25px;
    }
    li {
        margin-bottom: 8px;
    }
    table {
        width: 100%;
        border-collapse: collapse;
        margin: 20px 0;
    }
    th, td {
        border: 1px solid #ddd;
        padding: 10px;
        text-align: left;
    }
    th {
        background-color: #f2f2f2;
        color: #333;
    }
    .note {
        background-color: #fff3cd;
        border-left: 5px solid #ffc107;
        padding: 15px;
        margin-bottom: 20px;
    }
    .warning {
        background-color: #f8d7da;
        border-left: 5px solid #dc3545;
        padding: 15px;
        margin-bottom: 20px;
        color: #721c24;
    }
</style>
</head>
<body>

<h1>CD取り込み自動化ワークフロー・マスターGUI 要件定義書 (v3)</h1>

<div class="note">
    <strong>本書の位置づけ:</strong> 本ドキュメントは、ユーザー（定義者本人）の複雑なCD取り込みワークフローを管理・自動化するGUIアプリケーションの決定版要件定義書である。これまでの質疑応答に基づき、実装に必要な詳細仕様を網羅している。
</div>

<h2>1. プロジェクト概要</h2>

<h3>1.1. 目的とゴール</h3>
<p><strong>目的</strong>: 個人の趣味におけるCDリッピング作業（取り込み、音源分離、変換、タグ付け、アーカイブ）の手順を標準化し、GUIによるナビゲーションで「次に何をすべきか」を明確にする。</p>
<p><strong>ゴール</strong>: 全10ステップの作業を、迷うことなく、かつ手戻り（ヒューマンエラー）なく完遂できる状態を作る。</p>

<h3>1.2. ターゲットユーザー</h3>
<p>定義者本人（シングルユーザー）。高度なITスキルを持つが、煩雑な繰り返し作業におけるケアレスミスを防ぎたいと考えている。</p>

<h3>1.3. 開発・動作環境</h3>
<ul>
    <li><strong>OS</strong>: Windows 10 / 11 (64bit)</li>
    <li><strong>言語</strong>: Python 3.12</li>
    <li><strong>GUIフレームワーク</strong>: PySide6 (Qt for Python)</li>
    <li><strong>配布形態</strong>: ソースコード一式 + 仮想環境 + 起動用バッチファイル</li>
</ul>

<hr>

<h2>2. システム構成</h2>

<h3>2.1. 全体アーキテクチャ</h3>
<ol>
    <li><strong>マスターGUI (PySide6)</strong>: ユーザーインターフェースを提供し、全体の指揮を執る。</li>
    <li><strong>外部連携モジュール (QProcess)</strong>: 既存のコマンドラインツール（<code>FastCopy</code>, <code>flac</code>, <code>magick</code>等）やGUIツール（<code>Mp3tag</code>, <code>foobar2000</code>等）を起動・監視する。</li>
    <li><strong>状態管理モジュール</strong>: 作業フォルダ内の <code>state.json</code> を読み書きし、進捗を永続化する。</li>
</ol>

<h3>2.2. ディレクトリ構造要件</h3>

<h4>2.2.1. アプリケーション構成</h4>
<pre><code>[AppRoot]/
  ├─ LAUNCH_GUI.bat        # 起動用スクリプト（仮想環境自動判別）
  ├─ main.py               # アプリケーションエントリーポイント
  ├─ config.ini            # ユーザー設定（ツールパス、除外キーワード等）
  ├─ requirements.txt      # Python依存ライブラリリスト
  ├─ .venv/                # (自動生成) Python仮想環境
  └─ gui/, logic/          # ソースコード群</code></pre>

<h4>2.2.2. 作業フォルダ (work) のライフサイクル</h4>
<p><code>MusicCenterDir</code> から <code>work</code> にコピーされ、全工程を経て削除されるまで。</p>
<pre><code>work/
  └─ [ArtistName] - [AlbumName]/  <-- アルバムフォルダ（ルート）
       ├─ state.json              <-- ★最重要：進捗管理ファイル
       ├─ 01 - Track.flac         <-- 原本FLAC（随時リネーム・タグ更新される）
       ├─ 02 - Track (Inst).flac  <-- Demucsで分離されたインスト
       │
       ├─ htdemucs_ft/            <-- (Step2一時) Demucs出力。フォルダ名は可変
       ├─ _aac_output/            <-- (Step4成果) MediaHuman出力先
       ├─ _opus_output/           <-- (Step5成果) foobar2000出力先
       ├─ _artwork_resized/       <-- (Step6成果) magick出力先 (cover.jpg/webp)
       ├─ _final_flac/            <-- (Step8成果) 最終アーカイブ用
       └─ _logs/                  <-- 自動処理の実行ログ保存先</code></pre>

<hr>

<h2>3. 機能要件詳細</h2>

<h3>3.1. マスターGUI 基本機能</h3>

<h4>3.1.1. メイン画面レイアウト</h4>
<ul>
    <li><strong>左ペイン（アルバムリスト）</strong>: <code>work</code> フォルダ直下を常時監視（または更新ボタンでスキャン）し、<code>state.json</code> を持つフォルダを一覧表示する。各項目の横に現在のステップ数（例: <code>[Step 3/10] Album A</code>）を表示する。</li>
    <li><strong>右ペイン（作業エリア）</strong>: 選択中のアルバムの「現在のステップ」に応じた専用パネルを表示する。</li>
    <li><strong>上部ツールバー</strong>: 「新規取り込み」「設定」「再スキャン」ボタンを配置。</li>
    <li><strong>ステータスバー</strong>: アプリの動作状況（「準備完了」「Demucs実行中...」など）を表示。</li>
</ul>

<h4>3.1.2. 堅牢な状態管理</h4>
<ul>
    <li>各ステップの重要な操作（チェックボックス変更、外部ツール完了など）のたびに、メモリ上の状態を更新する。</li>
    <li>ステップ遷移時およびアプリ終了時には、必ず <code>state.json</code> にファイル書き込みを行う。</li>
</ul>

<h3>3.2. ワークフロー・ステップ詳細仕様</h3>

<h4>Step 1: 新規取り込み</h4>
<ul>
    <li><strong>目的</strong>: 作業対象のデータを <code>work</code> フォルダに安全に移動し、管理を開始する。</li>
    <li><strong>UI</strong>: フォルダ選択ダイアログ (<code>MusicCenterDir</code> を初期表示)。</li>
    <li><strong>処理フロー</strong>:
        <ol>
            <li>ユーザーが取り込み元のアルバムフォルダを選択。</li>
            <li>パスから「アーティスト名」「アルバム名」を自動推定（例: <code>.../Artist/Album</code> → Artist, Album）。</li>
            <li><code>work</code> フォルダ内に同名の移動先フォルダが存在しないかチェック。
                <ul>
                    <li>競合時: 「中断」か「既存を削除して上書き（危険）」を選択させる警告ダイアログを表示。</li>
                </ul>
            </li>
            <li><code>FastCopy</code> を非同期で実行し、フォルダを移動。</li>
            <li>移動完了後、<code>state.json</code> を新規作成し、メイン画面のリストを更新して自動的にそのアルバムを選択状態にする。</li>
        </ol>
    </li>
</ul>

<h4>Step 2: Demucs処理 (音源分離)</h4>
<ul>
    <li><strong>目的</strong>: ボーカル入りの曲からインストゥルメンタル版を作成する。</li>
    <li><strong>UI</strong>:
        <ul>
            <li>FLACファイル一覧とチェックボックス（複数選択可）。</li>
            <li>一括操作ボタン：「全選択」「全解除」。</li>
            <li>アクションボタン：「Demucs実行」（1つ以上選択時のみ有効）、「スキップ」（常に有効）。</li>
        </ul>
    </li>
    <li><strong>自動検出ロジック</strong>:
        <ul>
            <li><code>config.ini</code> の <code>[Demucs]SkipKeywords</code> に定義された単語（例: instrumental, off vocal）がファイル名に含まれる場合、初期状態でチェックを外す。</li>
            <li>さらに、そのインスト曲の「対になる原曲」も推定し、自動でチェックを外す（過剰な分離を防ぐ）。</li>
        </ul>
    </li>
    <li><strong>Demucs実行フロー</strong>:
        <ol>
            <li>ユーザーが外部（Colab等）でDemucsを実行。GUIは「Demucs完了」ボタンで待機。</li>
            <li>完了ボタン押下後、フォルダ選択ダイアログでDemucsの出力先を指定させる。</li>
            <li><strong>バリデーション</strong>: 指定フォルダ内に音声ファイルがあるか確認。なければエラー表示し、再指定を促す。</li>
            <li>発見した音声ファイルを <code>flac</code> で圧縮し、<code>metaflac</code> で「Instrumental」タグを付与して <code>work</code> ルートへ移動。</li>
        </ol>
    </li>
</ul>

<h4>Step 3: FLAC完成 (タグ・リネーム)</h4>
<ul>
    <li><strong>目的</strong>: FLACファイルのメタデータとファイル名を完成させる。</li>
    <li><strong>処理フロー</strong>:
        <ol>
            <li><code>Mp3tag</code> を起動。ユーザーは手動でタグ編集とリネームを行う。</li>
            <li>Mp3tag終了後、GUIは「ファイル紐づけ画面」を表示。</li>
            <li><strong>紐づけUI</strong>: 左に「元ファイル名」、右に「現在のファイル名」を並べ、ユーザーがドラッグ＆ドロップ等で対応関係を定義する。</li>
            <li><strong>アートワーク検査</strong>: <code>mutagen</code> で全ファイルをスキャン。1つも画像が埋め込まれていなければ、以降のStep 6, 7を自動スキップするフラグを立てる。</li>
        </ol>
    </li>
</ul>

<h4>Step 4 & 5: 変換 (AAC / Opus)</h4>
<ul>
    <li><strong>目的</strong>: ポータブルプレイヤーやストリーミング用の圧縮音源を作成する。</li>
    <li><strong>処理フロー</strong> (両ステップ共通):
        <ol>
            <li>対応するツール（<code>MediaHuman</code> / <code>foobar2000</code>）を起動。</li>
            <li>GUIは「ツール終了待ち」状態となる（強制進行ボタンあり）。</li>
            <li>ツール終了後、出力先フォルダ（デフォルトは <code>_aac_output</code> 等だが変更可）内のファイル数をカウントし、FLACの総トラック数と一致するかバリデーションを行う。</li>
        </ol>
    </li>
</ul>

<h4>Step 6: アートワーク縮小 (自動)</h4>
<ul>
    <li><strong>目的</strong>: 各種デバイスに適したサイズのジャケット画像を作成する。</li>
    <li><strong>前提</strong>: Step 3でアートワークありと判定されていること。</li>
    <li><strong>処理</strong>: 1曲目のFLACから <code>magick</code> で画像を抽出し、指定品質（<code>config.ini</code>で設定）の JPG/WebP にリサイズして保存する。</li>
</ul>

<h4>Step 7: アートワーク交換 (手動)</h4>
<ul>
    <li><strong>目的</strong>: 圧縮音源に、リサイズした軽量なアートワークを埋め込む。</li>
    <li><strong>処理</strong>: <code>Mp3tag</code> を起動し、画面上に「AACにはcover.jpgを、Opusにはcover.webpを埋め込んでください」といった具体的な指示を表示する。</li>
</ul>

<h4>Step 8: ReplayGain & アーカイブ</h4>
<ul>
    <li><strong>目的</strong>: 音量正規化情報を付与し、最終保存用のフォルダを作成する。</li>
    <li><strong>処理</strong>:
        <ol>
            <li><code>foobar2000</code> を起動し、ReplayGainスキャンを指示。</li>
            <li>終了後、<code>work</code> ルートの全FLACを <code>_final_flac</code> フォルダにコピーする。</li>
            <li>コピーが正しく行われたか（ファイル数チェック）をバリデーションする。</li>
        </ol>
    </li>
</ul>

<h4>Step 9: 最終配置 (転送)</h4>
<ul>
    <li><strong>目的</strong>: 完成した各フォーマットのファイルを定位置（NAS, クラウド等）に配備する。</li>
    <li><strong>処理</strong>: <code>WinSCP</code> を起動し、画面上に転送先や手順のチェックリストを表示する。ユーザーが「全作業完了」ボタンを押すと、アルバムのステータスが「COMPLETED」になる。</li>
</ul>

<h4>Step 10: クリーンアップ</h4>
<ul>
    <li><strong>目的</strong>: 不要になった作業ファイルを削除し、ディスクスペースを空ける。</li>
    <li><strong>処理</strong>: メイン画面で完了済みアルバムを選択し「削除」を実行すると、<code>send2trash</code> を用いてフォルダごとゴミ箱へ移動する（物理削除はしない）。</li>
</ul>

<hr>

<h2>4. データ定義詳細</h2>

<h3>4.1. `state.json` スキーマ定義</h3>
<pre><code>{
  "version": "1.0",               // ファイルフォーマットのバージョン
  "albumName": "Album Name",      // Step1で取得
  "artistName": "Artist Name",    // Step1で取得
  "currentStep": 3,               // 現在の進行ステップ (1~10)
  "status": "WAITING_USER",       // WAITING_USER, PROCESSING, ERROR, COMPLETED
  "tracks": [
    {
      "id": "unique_id_1",        // トラックを一意に識別するID
      "originalFile": "01.flac",  // 取り込み時のファイル名
      "finalFile": "01_New.flac", // Step3以降のファイル名
      "isDemucsTarget": false,    // Demucs処理対象か否か
      "isInstrumental": false     // (オプション) インスト曲フラグ
    }
  ],
  "paths": {                      // 各ステップの成果物フォルダパス（可変対応）
    "demucsOutput": "C:/.../htdemucs/Album",
    "aacOutput": "D:/work/Album/_aac_output"
  },
  "flags": {
    "hasArtwork": true,           // アートワーク有無
    "step2_skipped": false        // Step2をスキップしたか
  },
  "lastError": {                  // エラー発生時の情報保存
    "step": 2,
    "message": "Validation failed: No WAV files found.",
    "timestamp": "2025-11-09T10:00:00"
  }
}</code></pre>

<h3>4.2. `config.ini` 設定項目網羅</h3>
<pre><code>[App]
LogLevel = INFO                # DEBUG, INFO, WARNING, ERROR

[Paths]
# 各ツールの絶対パス。未設定時はPATHから探索を試みる。
FastCopy = ""
Mp3Tag = ""
MediaHuman = ""
Foobar2000 = ""
WinSCP = ""
Flac = ""
Metaflac = ""
Magick = ""

# デフォルトのディレクトリ
MusicCenterDir = "D:\Music\Music Center"
WorkDir = "D:\MyCdWorkflow\work"

[Demucs]
# 自動除外キーワード（カンマ区切り、大文字小文字無視）
SkipKeywords = instrumental, inst., off vocal, ...

[Artwork]
# リサイズ設定
JpegQuality = 85
WebpQuality = 85
ResizeWidth = 600</code></pre>

</body>
</html>